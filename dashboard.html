<!DOCTYPE html>
<html>
<head>
  <title>Google Drive Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    body {
      font-family: Arial;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }

    .container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #1a73e8;
      color: white;
    }

    button.danger {
      background: #d93025;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    input[type="file"] {
      margin: 15px 0;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üìÅ Google Drive Manager</h2>
  <button onclick="signOut()">üö™ Sign Out</button>
</div>

<div class="container">
  <h3>Upload File</h3>
  <input type="file" id="fileInput">
  <button onclick="uploadFile()">Upload</button>
  <p id="status"></p>
</div>

<div class="container">
  <h3>Files</h3>
  <button onclick="loadFiles()">Refresh</button>
  <div id="fileList"></div>
</div>

<script>
const CLIENT_ID = "YOUR_CLIENT_ID";
const API_KEY = "YOUR_API_KEY";
const FOLDER_ID = "YOUR_FOLDER_ID";

let accessToken = localStorage.getItem("drive_token");

if (!accessToken) {
  window.location.href = "index.html";
}

gapi.load("client", async () => {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
  });

  loadFiles();
});

function showStatus(message) {
  document.getElementById("status").innerText = message;
}

async function loadFiles() {
  try {
    const response = await gapi.client.drive.files.list({
      q: `'${FOLDER_ID}' in parents and trashed=false`,
      fields: "files(id,name,webViewLink)"
    });

    const files = response.result.files;
    const fileList = document.getElementById("fileList");

    fileList.innerHTML = "";

    files.forEach(file => {
      fileList.innerHTML += `
        <div class="file-item">
          <span>${file.name}</span>
          <div>
            <button onclick="window.open('${file.webViewLink}')">View</button>
            <button class="danger" onclick="deleteFile('${file.id}')">Delete</button>
          </div>
        </div>
      `;
    });

  } catch (error) {
    if (error.status === 401) {
      sessionExpired();
    }
  }
}

async function uploadFile() {
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];

  if (!file) {
    showStatus("Select a file first.");
    return;
  }

  showStatus("Uploading...");

  const metadata = {
    name: file.name,
    parents: [FOLDER_ID]
  };

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], {type: "application/json"}));
  form.append("file", file);

  try {
    const response = await fetch(
      "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
      {
        method: "POST",
        headers: { Authorization: "Bearer " + accessToken },
        body: form
      }
    );

    if (!response.ok) throw response;

    showStatus("Upload successful!");
    fileInput.value = "";
    loadFiles();

  } catch (error) {
    if (error.status === 401) {
      sessionExpired();
    } else {
      showStatus("Upload failed.");
    }
  }
}

async function deleteFile(fileId) {
  if (!confirm("Delete this file?")) return;

  try {
    const response = await fetch(
      `https://www.googleapis.com/drive/v3/files/${fileId}`,
      {
        method: "DELETE",
        headers: { Authorization: "Bearer " + accessToken }
      }
    );

    if (!response.ok) throw response;

    loadFiles();

  } catch (error) {
    if (error.status === 401) {
      sessionExpired();
    }
  }
}

function signOut() {
  localStorage.removeItem("drive_token");
  window.location.href = "index.html";
}

function sessionExpired() {
  localStorage.removeItem("drive_token");
  alert("Session expired. Please sign in again.");
  window.location.href = "index.html";
}
</script>

</body>
</html>