<!DOCTYPE html>  
<html>  
<head>  
  <title>Google Drive Uploader</title>  
  <meta name="google-signin-client_id" content="789202929495-8ga0rfnv1m9ea0g4p48lmfvraa739aa8.apps.googleusercontent.com">  
</head>  
<body>  
  
<h2>Google Drive File Manager</h2>  
  
<!-- Login Button -->  
<div id="signin-button"></div>  
  
<!-- Upload Section (Hidden until signed in) -->  
<div id="upload-section" style="display:none;">  
  <h3>Upload Files</h3>  
  <input type="file" id="file-input" multiple>  
  <button onclick="uploadToDrive()">Upload to Google Drive</button>  
  <p id="status"></p>  
</div>  
  
<!-- Debug Info -->  
<div id="debug-info" style="background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; display:none;">  
  <h4>Debug Information</h4>  
  <pre id="debug-output"></pre>  
</div>  
  
<!-- Files List -->  
<div id="files-container">  
  <h3>Files in Public Folder</h3>  
  <div id="files-list"></div>  
</div>  
  
<!-- Google APIs -->  
<script src="https://apis.google.com/js/api.js"></script>  
<script src="https://accounts.google.com/gsi/client"></script>  
  
<script>  
// Configuration
const CLIENT_ID = '789202929495-8ga0rfnv1m9ea0g4p48lmfvraa739aa8.apps.googleusercontent.com';  
const API_KEY = "AIzaSyC2HJNSHQbJ6b3hpmborEq1tnxmj8BsQ30";  
const FOLDER_ID = "1gpiHZSJXNOu6F8rTlalVrfuvspXZoVwk";  
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive';  
  
let accessToken = null;  
  
// Debug logging
function debugLog(message, data = null) {
  console.log(message, data || '');
  const debugDiv = document.getElementById('debug-info');
  const debugOutput = document.getElementById('debug-output');
  
  if (debugDiv.style.display === 'none') {
    debugDiv.style.display = 'block';
  }
  
  const timestamp = new Date().toLocaleTimeString();
  let logMessage = `${timestamp}: ${message}`;
  
  if (data) {
    if (typeof data === 'object') {
      logMessage += '\n' + JSON.stringify(data, null, 2);
    } else {
      logMessage += '\n' + data;
    }
  }
  
  debugOutput.innerHTML = logMessage + '\n\n' + debugOutput.innerHTML;
}

// Initialize Google APIs  
function initGoogleAuth() {  
  debugLog('Initializing Google APIs...');
  
  gapi.load('client', async () => {  
    try {
      debugLog('Loading gapi client...');
      
      await gapi.client.init({  
        apiKey: API_KEY,  
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']  
      });  
      
      debugLog('gapi client initialized');
  
      // Initialize Google Identity Services  
      google.accounts.id.initialize({  
        client_id: CLIENT_ID,  
        callback: handleCredentialResponse,  
        scope: SCOPES,
        ux_mode: 'popup'
      });  
  
      // Render sign-in button  
      google.accounts.id.renderButton(  
        document.getElementById('signin-button'),  
        { theme: 'outline', size: 'large', type: 'standard', text: 'signin_with' }  
      );  
      
      debugLog('Google Identity Services initialized');
  
      loadPublicFiles();  
    } catch (error) {
      debugLog('Error initializing Google APIs:', error);
    }
  });  
}  
  
// Handle OAuth response  
function handleCredentialResponse(response) {  
  debugLog('OAuth response received:', response);
  
  if (response.error) {
    debugLog('OAuth error:', response.error);
    alert('Sign-in failed: ' + response.error);
    return;
  }
  
  // Get the access token from the credential response
  accessToken = response.credential || response.access_token;
  
  if (!accessToken) {
    debugLog('No access token found in response');
    // Try to get token from auth2 if available
    if (window.gapi && gapi.auth2) {
      const auth2 = gapi.auth2.getAuthInstance();
      if (auth2) {
        const user = auth2.currentUser.get();
        const authResponse = user.getAuthResponse();
        accessToken = authResponse.access_token;
        debugLog('Got access token from gapi.auth2:', accessToken ? 'Yes' : 'No');
      }
    }
  }
  
  debugLog('Access token status:', accessToken ? 'Token obtained' : 'No token');
  
  document.getElementById('upload-section').style.display = 'block';  
  document.getElementById('signin-button').style.display = 'none';  
  
  // Test the access token
  setTimeout(testDriveAccess, 1000);
}  
  
// Test Drive API access
async function testDriveAccess() {
  if (!accessToken) {
    debugLog('No access token available for testing');
    return;
  }
  
  try {
    debugLog('Testing Drive API access...');
    
    // Simple test to check if we can access Drive API
    const testResponse = await fetch('https://www.googleapis.com/drive/v3/about?fields=user,storageQuota', {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await testResponse.json();
    debugLog('Drive API test result:', result);
    
    if (result.error) {
      debugLog('Drive API access error:', result.error);
      document.getElementById('status').innerHTML = 
        `<span style="color:orange;">Warning: Limited access. Error: ${result.error.message}</span>`;
    } else {
      debugLog('Drive API access successful');
      document.getElementById('status').innerHTML = 
        `<span style="color:green;">‚úì Connected as: ${result.user.emailAddress}</span>`;
    }
  } catch (error) {
    debugLog('Drive API test failed:', error);
  }
}

// Load files from public folder (no authentication needed)  
async function loadPublicFiles() {  
  try {  
    debugLog('Loading public files from folder:', FOLDER_ID);
    
    const response = await gapi.client.drive.files.list({  
      q: `'${FOLDER_ID}' in parents and trashed = false`,  
      fields: 'files(id, name, mimeType, webViewLink, size, modifiedTime)',  
      orderBy: 'modifiedTime desc',
      pageSize: 20
    });  
  
    const files = response.result.files;  
    const filesList = document.getElementById('files-list');  
    
    debugLog('Files loaded:', files ? files.length : 0);
  
    if (!files || files.length === 0) {  
      filesList.innerHTML = '<p>No files found.</p>';  
      return;  
    }  
  
    let html = '<ul style="list-style: none; padding: 0;">';  
    files.forEach(file => {  
      const icon = file.mimeType.includes('folder') ? 'üìÅ' : 
                   file.mimeType.includes('image') ? 'üñºÔ∏è' :
                   file.mimeType.includes('pdf') ? 'üìï' :
                   file.mimeType.includes('video') ? 'üé¨' : 'üìÑ';
      const downloadLink = `https://drive.google.com/uc?export=download&id=${file.id}`;  
      const size = file.size ? ` (${formatBytes(file.size)})` : '';  
      const modified = file.modifiedTime ? new Date(file.modifiedTime).toLocaleDateString() : '';
      
      html += `  
        <li style="margin: 10px 0; padding: 10px; border: 1px solid #eee; border-radius: 5px;">  
          <div style="font-size: 20px; float: left; margin-right: 10px;">${icon}</div>  
          <div style="margin-left: 40px;">  
            <strong>${file.name}</strong>${size}<br>  
            <small style="color: #666;">Modified: ${modified}</small><br>  
            <a href="${downloadLink}" target="_blank" style="color: #1a73e8; text-decoration: none;">‚¨áÔ∏è Download</a>  
            <a href="${file.webViewLink}" target="_blank" style="color: #1a73e8; text-decoration: none; margin-left: 15px;">üëÅÔ∏è View in Drive</a>  
          </div>  
          <div style="clear: both;"></div>  
        </li>  
      `;  
    });  
    html += '</ul>';  
  
    filesList.innerHTML = html;  
  } catch (error) {  
    debugLog('Error loading files:', error);  
    document.getElementById('files-list').innerHTML =   
      `<p style="color: red;">Error loading files: ${error.message}</p>  
       <p><small>Make sure folder is public and accessible.</small></p>`;  
  }  
}  
  
// Upload file to Google Drive  
async function uploadToDrive() {  
  const fileInput = document.getElementById('file-input');  
  const status = document.getElementById('status');  
  
  if (!fileInput.files.length) {  
    status.innerHTML = '<span style="color:red;">Please select a file first.</span>';  
    return;  
  }  
  
  if (!accessToken) {  
    status.innerHTML = '<span style="color:red;">Please sign in first.</span>';  
    return;  
  }  
  
  const file = fileInput.files[0];  
  status.innerHTML = `<span style="color:blue;">Uploading "${file.name}"... (Size: ${formatBytes(file.size)})</span>`;  
  
  debugLog('Starting upload:', {
    fileName: file.name,
    fileType: file.type,
    fileSize: file.size,
    accessToken: accessToken.substring(0, 20) + '...'
  });
  
  try {  
    // Create metadata  
    const metadata = {  
      name: file.name,  
      parents: [FOLDER_ID],
      mimeType: file.type || 'application/octet-stream'
    };  
    
    debugLog('Upload metadata:', metadata);
    
    // Create FormData for upload  
    const form = new FormData();  
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));  
    form.append('file', file);  
    
    // Log FormData contents (for debugging)
    debugLog('FormData created');
    
    // Upload to Google Drive  
    const uploadUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,size';
    
    debugLog('Sending request to:', uploadUrl);
    
    const response = await fetch(uploadUrl, {  
      method: 'POST',  
      headers: {
        'Authorization': `Bearer ${accessToken}`
      },  
      body: form  
    });  
    
    debugLog('Response received:', {
      status: response.status,
      statusText: response.statusText,
      ok: response.ok
    });
    
    const responseText = await response.text();  
    debugLog('Response text:', responseText);
    
    if (!response.ok) {  
      let errorMessage = `Upload failed: ${response.status} ${response.statusText}`;  
      try {  
        const errorJson = JSON.parse(responseText);  
        errorMessage += ` - ${errorJson.error?.message || JSON.stringify(errorJson)}`;  
        
        // Specific error handling
        if (errorJson.error?.code === 403) {
          errorMessage += '\n\nPossible causes:\n';
          errorMessage += '1. Drive API not enabled in Google Cloud Console\n';
          errorMessage += '2. Insufficient OAuth scopes\n';
          errorMessage += '3. Token expired or invalid\n';
          errorMessage += '4. Folder permissions issue';
        }
        
      } catch (e) {  
        errorMessage += ` - ${responseText}`;  
      }  
      throw new Error(errorMessage);  
    }  
    
    const result = JSON.parse(responseText);  
    debugLog('Upload successful:', result);
    
    status.innerHTML = `  
      <span style="color:green;">  
        ‚úÖ Upload successful!<br>  
        <small>  
          File: ${result.name}<br>  
          <a href="https://drive.google.com/file/d/${result.id}/view" target="_blank">View in Drive</a> |  
          <a href="https://drive.google.com/uc?export=download&id=${result.id}" target="_blank">Download</a>  
        </small>  
      </span>  
    `;  
    
    // Clear file input and reload list  
    fileInput.value = '';  
    loadPublicFiles();  
  
  } catch (error) {  
    console.error('Upload error:', error);  
    debugLog('Upload failed with error:', error);
    
    let errorHtml = `<span style="color:red;">Upload failed: ${error.message}</span>`;  
    
    // Add troubleshooting tips
    if (error.message.includes('403')) {
      errorHtml += `<br><br><small style="color: #666;">
        <strong>Troubleshooting tips:</strong><br>
        1. Go to <a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank">Google Cloud Console</a><br>
        2. Enable Google Drive API<br>
        3. Make sure your OAuth client has the correct scopes<br>
        4. Add your email as a test user in OAuth consent screen
      </small>`;
    } else if (error.message.includes('401')) {
      errorHtml += `<br><br><small style="color: #666;">Token may have expired. Try signing out and back in.</small>`;
    }
    
    status.innerHTML = errorHtml;  
  }  
}  
  
// Alternative upload method using gapi.client directly
async function uploadToDriveAlternative() {
  const fileInput = document.getElementById('file-input');
  const status = document.getElementById('status');
  
  if (!fileInput.files.length) {
    status.innerHTML = '<span style="color:red;">Please select a file first.</span>';
    return;
  }
  
  const file = fileInput.files[0];
  status.innerHTML = `<span style="color:blue;">Uploading "${file.name}" (Alternative method)...</span>`;
  
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      const boundary = '-------314159265358979323846';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";
      
      const metadata = {
        'name': file.name,
        'parents': [FOLDER_ID],
        'mimeType': file.type
      };
      
      const multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: ' + file.type + '\r\n\r\n' +
        e.target.result +
        close_delim;
      
      const request = gapi.client.request({
        'path': '/upload/drive/v3/files',
        'method': 'POST',
        'params': {'uploadType': 'multipart'},
        'headers': {
          'Content-Type': 'multipart/related; boundary="' + boundary + '"'
        },
        'body': multipartRequestBody
      });
      
      const response = await request;
      debugLog('Alternative upload successful:', response);
      status.innerHTML = `<span style="color:green;">‚úÖ Upload successful!</span>`;
      loadPublicFiles();
      
    } catch (error) {
      debugLog('Alternative upload failed:', error);
      status.innerHTML = `<span style="color:red;">Error: ${error.result?.error?.message || error.message}</span>`;
    }
  };
  
  reader.readAsBinaryString(file);
}

// Helper function to format file sizes  
function formatBytes(bytes, decimals = 2) {  
  if (bytes === 0) return '0 Bytes';  
  const k = 1024;  
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];  
  const i = Math.floor(Math.log(bytes) / Math.log(k));  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];  
}  
  
// Sign out function  
function signOut() {  
  debugLog('Signing out...');
  
  // Clear Google Sign-In
  if (google.accounts.id) {
    google.accounts.id.disableAutoSelect();
  }
  
  // Clear tokens and state
  accessToken = null;
  
  // Reset UI
  document.getElementById('upload-section').style.display = 'none';  
  document.getElementById('signin-button').style.display = 'block';  
  document.getElementById('status').innerHTML = '';
  document.getElementById('debug-info').style.display = 'none';
  
  debugLog('Signed out successfully');
  
  // Reload files list (public access)
  loadPublicFiles();
}  
  
// Toggle debug panel
function toggleDebug() {
  const debugDiv = document.getElementById('debug-info');
  debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
}

// Initialize when page loads  
window.onload = function() {
  debugLog('Page loaded, initializing...');
  initGoogleAuth();
};
</script>  
  
<div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">  
  <button onclick="signOut()" style="background: #f44336; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">  
    Sign Out  
  </button>
  
  <button onclick="testDriveAccess()" style="background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">  
    Test Connection  
  </button>
  
  <button onclick="loadPublicFiles()" style="background: #2196F3; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">  
    Refresh Files  
  </button>
  
  <button onclick="toggleDebug()" style="background: #FF9800; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">  
    Toggle Debug  
  </button>
  
  <p style="margin-top: 10px; font-size: 12px; color: #666;">
    Folder ID: <code>${FOLDER_ID}</code><br>
    Client ID: <code>${CLIENT_ID.substring(0, 20)}...</code>
  </p>
</div>  
  
</body>  
</html>