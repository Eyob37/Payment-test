<!DOCTYPE html>
<html>
<head>
  <title>Google Drive Upload</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    #signin-button { margin: 20px 0; }
    #status { margin-top: 10px; padding: 10px; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .file-list { list-style: none; padding: 0; }
    .file-list li { padding: 8px; border-bottom: 1px solid #eee; }
    .debug { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; }
  </style>
</head>
<body>

<h1>üìÅ Google Drive File Manager</h1>

<!-- Step 1: Setup Instructions -->
<div class="section">
  <h3>üîß Setup Instructions:</h3>
  <ol>
    <li>Get your <strong>Client ID</strong> from Google Cloud Console</li>
    <li>Get your <strong>API Key</strong> from Google Cloud Console</li>
    <li>Get your <strong>Folder ID</strong> from Google Drive</li>
    <li>Update the values in the code below</li>
  </ol>
  <button onclick="showConfig()">Show Current Configuration</button>
</div>

<!-- Step 2: Authentication -->
<div class="section">
  <h3>üîê Authentication</h3>
  <p>Sign in to upload files. Viewing files doesn't require sign-in.</p>
  <div id="signin-button"></div>
  <div id="auth-status"></div>
</div>

<!-- Step 3: Upload Files -->
<div class="section" id="upload-section" style="display:none;">
  <h3>üì§ Upload Files</h3>
  <input type="file" id="file-input" multiple>
  <button onclick="uploadToDrive()">Upload to Drive</button>
  <button onclick="createFolder()">Create New Folder</button>
  <div id="status"></div>
</div>

<!-- Step 4: View Files -->
<div class="section">
  <h3>üìÇ Files in Public Folder</h3>
  <button onclick="loadPublicFiles()">Refresh Files</button>
  <div id="files-list">Loading...</div>
</div>

<!-- Debug Info -->
<div class="section debug">
  <h4>Debug Information:</h4>
  <div id="debug-info"></div>
</div>

<!-- Load Google APIs -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
// ============ CONFIGURATION ============
// REPLACE THESE VALUES WITH YOUR OWN
const CONFIG = {
  const CLIENT_ID = '789202929495-8ga0rfnv1m9ea0g4p48lmfvraa739aa8.apps.googleusercontent.com';
const API_KEY = "AIzaSyC2HJNSHQbJ6b3hpmborEq1tnxmj8BsQ30";
const FOLDER_ID = "1gpiHZSJXNOu6F8rTlalVrfuvspXZoVwk";
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
};

let accessToken = null;
let debugInfo = '';

// ============ INITIALIZATION ============
async function initGoogleAuth() {
  try {
    debug('Initializing Google APIs...');
    
    // Load gapi client
    await new Promise((resolve, reject) => {
      gapi.load('client', { callback: resolve, onerror: reject });
    });
    
    debug('gapi client loaded');
    
    // Initialize gapi client
    await gapi.client.init({
      apiKey: CONFIG.API_KEY,
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
    });
    
    debug('gapi client initialized');
    
    // Initialize Google Identity Services
    google.accounts.id.initialize({
      client_id: CONFIG.CLIENT_ID,
      callback: handleCredentialResponse,
      scope: CONFIG.SCOPES,
      ux_mode: 'popup'
    });
    
    debug('Google Identity Services initialized');
    
    // Render sign-in button
    google.accounts.id.renderButton(
      document.getElementById('signin-button'),
      { 
        theme: 'filled_blue', 
        size: 'large', 
        text: 'signin_with',
        shape: 'rectangular',
        logo_alignment: 'left'
      }
    );
    
    // Also add a sign-out button
    const signoutBtn = document.createElement('button');
    signoutBtn.innerHTML = 'Sign Out';
    signoutBtn.onclick = signOut;
    signoutBtn.style.background = '#f44336';
    signoutBtn.style.color = 'white';
    document.getElementById('signin-button').appendChild(signoutBtn);
    
    // Check if already signed in
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CONFIG.CLIENT_ID,
      scope: CONFIG.SCOPES,
      callback: (tokenResponse) => {
        if (tokenResponse && tokenResponse.access_token) {
          accessToken = tokenResponse.access_token;
          document.getElementById('upload-section').style.display = 'block';
          document.getElementById('auth-status').innerHTML = 
            '<div class="success">‚úÖ Signed in successfully!</div>';
          debug('Access token obtained');
        }
      },
    });
    
    // Load files initially
    loadPublicFiles();
    
  } catch (error) {
    debug('Initialization error: ' + error.message);
    showError('Failed to initialize: ' + error.message);
  }
}

// ============ AUTH HANDLING ============
function handleCredentialResponse(response) {
  debug('OAuth response received');
  
  if (response.error) {
    debug('OAuth error: ' + response.error);
    showError('Authentication failed: ' + response.error);
    return;
  }
  
  // Get access token using token client
  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CONFIG.CLIENT_ID,
    scope: CONFIG.SCOPES,
    callback: (tokenResponse) => {
      if (tokenResponse && tokenResponse.access_token) {
        accessToken = tokenResponse.access_token;
        document.getElementById('upload-section').style.display = 'block';
        document.getElementById('auth-status').innerHTML = 
          '<div class="success">‚úÖ Signed in successfully! Token: ' + 
          accessToken.substring(0, 20) + '...</div>';
        debug('Access token obtained: ' + accessToken.substring(0, 30) + '...');
      }
    },
  });
  
  tokenClient.requestAccessToken();
}

// ============ FILE UPLOAD ============
async function uploadToDrive() {
  const fileInput = document.getElementById('file-input');
  const statusDiv = document.getElementById('status');
  
  if (!fileInput.files.length) {
    showStatus('Please select a file first.', 'error');
    return;
  }
  
  if (!accessToken) {
    showStatus('Please sign in first.', 'error');
    return;
  }
  
  const file = fileInput.files[0];
  showStatus(`Uploading "${file.name}"...`, 'info');
  
  debug(`Starting upload: ${file.name} (${file.size} bytes, ${file.type})`);
  
  try {
    // Method 1: Using Fetch API (most reliable)
    await uploadWithFetch(file);
    
  } catch (error) {
    debug('Upload error: ' + error.message);
    showStatus(`Upload failed: ${error.message}`, 'error');
    
    // Try alternative method
    try {
      debug('Trying alternative upload method...');
      await uploadAlternative(file);
    } catch (error2) {
      debug('Alternative upload also failed: ' + error2.message);
      showStatus(`All upload methods failed: ${error2.message}`, 'error');
    }
  }
}

// Method 1: Using Fetch API
async function uploadWithFetch(file) {
  debug('Using Fetch API for upload...');
  
  // Create file metadata
  const metadata = {
    name: file.name,
    parents: [CONFIG.FOLDER_ID]
  };
  
  // Create FormData
  const formData = new FormData();
  formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  formData.append('file', file);
  
  // Upload to Google Drive
  const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`
    },
    body: formData
  });
  
  debug(`Upload response status: ${response.status}`);
  
  if (!response.ok) {
    const errorText = await response.text();
    debug(`Upload failed: ${response.status} - ${errorText}`);
    throw new Error(`HTTP ${response.status}: ${errorText}`);
  }
  
  const result = await response.json();
  debug('Upload successful: ' + JSON.stringify(result));
  
  showStatus(
    `‚úÖ Upload successful! ` +
    `<a href="https://drive.google.com/file/d/${result.id}/view" target="_blank">View File</a>`,
    'success'
  );
  
  // Clear file input and reload files
  document.getElementById('file-input').value = '';
  loadPublicFiles();
}

// Method 2: Alternative using gapi.client
async function uploadAlternative(file) {
  debug('Trying alternative upload with gapi.client...');
  
  const metadata = {
    name: file.name,
    parents: [CONFIG.FOLDER_ID]
  };
  
  // Read file as base64
  const reader = new FileReader();
  const fileContent = await new Promise((resolve) => {
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
  
  const response = await gapi.client.drive.files.create({
    resource: metadata,
    media: {
      mimeType: file.type,
      body: fileContent
    },
    fields: 'id,name,webViewLink'
  });
  
  debug('Alternative upload successful: ' + JSON.stringify(response.result));
  
  showStatus(
    `‚úÖ Upload successful (alternative method)! ` +
    `<a href="${response.result.webViewLink}" target="_blank">View File</a>`,
    'success'
  );
  
  document.getElementById('file-input').value = '';
  loadPublicFiles();
}

// ============ CREATE FOLDER ============
async function createFolder() {
  if (!accessToken) {
    showStatus('Please sign in first.', 'error');
    return;
  }
  
  const folderName = prompt('Enter folder name:');
  if (!folderName) return;
  
  showStatus(`Creating folder "${folderName}"...`, 'info');
  
  try {
    const metadata = {
      name: folderName,
      mimeType: 'application/vnd.google-apps.folder',
      parents: [CONFIG.FOLDER_ID]
    };
    
    const response = await fetch('https://www.googleapis.com/drive/v3/files', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(metadata)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    showStatus(`‚úÖ Folder created successfully!`, 'success');
    loadPublicFiles();
    
  } catch (error) {
    showStatus(`Failed to create folder: ${error.message}`, 'error');
  }
}

// ============ LOAD FILES ============
async function loadPublicFiles() {
  const filesList = document.getElementById('files-list');
  filesList.innerHTML = 'Loading...';
  
  try {
    // Use API key for public folder access
    const response = await gapi.client.drive.files.list({
      q: `'${CONFIG.FOLDER_ID}' in parents and trashed = false`,
      fields: 'files(id, name, mimeType, webViewLink, size, modifiedTime)',
      orderBy: 'modifiedTime desc',
      pageSize: 50
    });
    
    const files = response.result.files;
    debug(`Loaded ${files ? files.length : 0} files`);
    
    if (!files || files.length === 0) {
      filesList.innerHTML = '<p>No files found in this folder.</p>';
      return;
    }
    
    let html = '<ul class="file-list">';
    files.forEach(file => {
      const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
      const icon = isFolder ? 'üìÅ' : 'üìÑ';
      const modified = new Date(file.modifiedTime).toLocaleDateString();
      const size = file.size ? ` (${formatBytes(file.size)})` : '';
      
      if (isFolder) {
        html += `
          <li>
            ${icon} <strong>${file.name}</strong>
            <br><small>Modified: ${modified} | Folder</small>
          </li>
        `;
      } else {
        const downloadLink = `https://drive.google.com/uc?export=download&id=${file.id}`;
        html += `
          <li>
            ${icon} <a href="${downloadLink}" target="_blank">${file.name}</a>${size}
            <br><small>Modified: ${modified} | 
            <a href="${file.webViewLink}" target="_blank">View</a> | 
            <a href="${downloadLink}" target="_blank">Download</a></small>
          </li>
        `;
      }
    });
    html += '</ul>';
    
    filesList.innerHTML = html;
    
  } catch (error) {
    debug('Error loading files: ' + error.message);
    filesList.innerHTML = `
      <div class="error">
        Error loading files. Make sure:<br>
        1. Folder is public (Share ‚Üí Anyone with the link)<br>
        2. API Key is correct<br>
        3. Folder ID is correct
      </div>
    `;
  }
}

// ============ HELPER FUNCTIONS ============
function formatBytes(bytes, decimals = 2) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
}

function showStatus(message, type) {
  const statusDiv = document.getElementById('status');
  statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
}

function showError(message) {
  showStatus(message, 'error');
}

function debug(info) {
  debugInfo += new Date().toLocaleTimeString() + ': ' + info + '\n';
  document.getElementById('debug-info').innerText = debugInfo;
}

function showConfig() {
  alert(`Current Configuration:\n\n` +
    `Client ID: ${CONFIG.CLIENT_ID}\n` +
    `API Key: ${CONFIG.API_KEY}\n` +
    `Folder ID: ${CONFIG.FOLDER_ID}\n` +
    `Access Token: ${accessToken ? 'Present' : 'Not set'}`);
}

function signOut() {
  if (accessToken) {
    google.accounts.oauth2.revoke(accessToken, () => {
      debug('User signed out');
    });
  }
  accessToken = null;
  document.getElementById('upload-section').style.display = 'none';
  document.getElementById('auth-status').innerHTML = '';
  document.getElementById('status').innerHTML = '';
  google.accounts.id.disableAutoSelect();
  debug('Session cleared');
}

// ============ START APPLICATION ============
window.onload = initGoogleAuth;
</script>

</body>
</html>