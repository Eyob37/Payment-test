<!DOCTYPE html>  
<html>  
<head>  
  <title>Google Drive Uploader</title>  
  <meta name="google-signin-client_id" content="789202929495-8ga0rfnv1m9ea0g4p48lmfvraa739aa8.apps.googleusercontent.com">  
</head>  
<body>  
  
<h2>Google Drive File Manager</h2>  
  
<!-- Login Button -->  
<div id="signin-button"></div>  
  
<!-- Upload Section (Hidden until signed in) -->  
<div id="upload-section" style="display:none;">  
  <h3>Upload Files</h3>  
  <input type="file" id="file-input" multiple>  
  <button onclick="uploadToDrive()">Upload to Google Drive</button>  
  <p id="status"></p>  
</div>  
  
<!-- Files List -->  
<div id="files-container">  
  <h3>Files in Public Folder</h3>  
  <div id="files-list"></div>  
</div>  
  
<!-- Google APIs -->  
<script src="https://apis.google.com/js/api.js"></script>  
<script src="https://accounts.google.com/gsi/client"></script>  
  
<script>  
// Configuration
const CLIENT_ID = '789202929495-8ga0rfnv1m9ea0g4p48lmfvraa739aa8.apps.googleusercontent.com';  
const API_KEY = "AIzaSyC2HJNSHQbJ6b3hpmborEq1tnxmj8BsQ30";  
const FOLDER_ID = "1gpiHZSJXNOu6F8rTlalVrfuvspXZoVwk";  
const SCOPES = 'https://www.googleapis.com/auth/drive.file';  
  
let accessToken = null;  
let tokenClient;  
  
// Initialize Google APIs  
function initGoogleAuth() {  
  console.log('Initializing Google APIs...');
  
  // Initialize Google Identity Services
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      console.log('Token response received:', tokenResponse);
      if (tokenResponse && tokenResponse.access_token) {
        accessToken = tokenResponse.access_token;
        console.log('Access token obtained:', accessToken.substring(0, 20) + '...');
        
        document.getElementById('upload-section').style.display = 'block';  
        document.getElementById('signin-button').style.display = 'none';  
        
        // Test the token
        testToken();
      } else {
        console.error('No access token in response:', tokenResponse);
        alert('Failed to get access token. Please try again.');
      }
    },
    error_callback: (error) => {
      console.error('Token client error:', error);
      alert('Authentication error: ' + error.message);
    }
  });
  
  // Render sign-in button
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false
  });
  
  google.accounts.id.renderButton(
    document.getElementById('signin-button'),
    {
      type: 'standard',
      theme: 'outline',
      size: 'large',
      text: 'signin_with',
      shape: 'rectangular',
      logo_alignment: 'left'
    }
  );
  
  // Initialize gapi client
  gapi.load('client', async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
    });
    console.log('gapi client initialized');
    loadPublicFiles();
  });
}  
  
// Handle One Tap sign-in
function handleCredentialResponse(response) {
  console.log('One Tap response:', response);
  
  // Get the access token using the token client
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    alert('Token client not initialized. Please refresh the page.');
  }
}

// Test if the access token works
async function testToken() {
  if (!accessToken) {
    console.log('No access token to test');
    return;
  }
  
  try {
    console.log('Testing access token...');
    const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });
    
    if (response.ok) {
      const userInfo = await response.json();
      console.log('Token valid for user:', userInfo.email);
      document.getElementById('status').innerHTML = 
        `<span style="color:green;">‚úì Connected as: ${userInfo.email}</span>`;
    } else {
      console.error('Token test failed:', response.status);
      document.getElementById('status').innerHTML = 
        `<span style="color:orange;">Token may have issues (${response.status})</span>`;
    }
  } catch (error) {
    console.error('Token test error:', error);
  }
}

// Load files from public folder  
async function loadPublicFiles() {  
  try {  
    console.log('Loading files from folder:', FOLDER_ID);
    
    const response = await gapi.client.drive.files.list({  
      q: `'${FOLDER_ID}' in parents and trashed = false`,  
      fields: 'files(id, name, mimeType, webViewLink, size, modifiedTime)',  
      orderBy: 'modifiedTime desc',
      pageSize: 20
    });  
  
    const files = response.result.files;  
    const filesList = document.getElementById('files-list');  
    
    console.log('Files loaded:', files ? files.length : 0);
  
    if (!files || files.length === 0) {  
      filesList.innerHTML = '<p>No files found.</p>';  
      return;  
    }  
  
    let html = '<ul style="list-style: none; padding: 0;">';  
    files.forEach(file => {  
      const icon = file.mimeType.includes('folder') ? 'üìÅ' : 
                   file.mimeType.includes('image') ? 'üñºÔ∏è' :
                   file.mimeType.includes('pdf') ? 'üìï' :
                   file.mimeType.includes('video') ? 'üé¨' : 'üìÑ';
      const downloadLink = `https://drive.google.com/uc?export=download&id=${file.id}`;  
      const size = file.size ? ` (${formatBytes(file.size)})` : '';  
      const modified = file.modifiedTime ? new Date(file.modifiedTime).toLocaleDateString() : '';
      
      html += `  
        <li style="margin: 10px 0; padding: 10px; border: 1px solid #eee; border-radius: 5px;">  
          <div style="font-size: 20px; float: left; margin-right: 10px;">${icon}</div>  
          <div style="margin-left: 40px;">  
            <strong>${file.name}</strong>${size}<br>  
            <small style="color: #666;">Modified: ${modified}</small><br>  
            <a href="${downloadLink}" target="_blank" style="color: #1a73e8; text-decoration: none;">‚¨áÔ∏è Download</a>  
            <a href="${file.webViewLink}" target="_blank" style="color: #1a73e8; text-decoration: none; margin-left: 15px;">üëÅÔ∏è View in Drive</a>  
          </div>  
          <div style="clear: both;"></div>  
        </li>  
      `;  
    });  
    html += '</ul>';  
  
    filesList.innerHTML = html;  
  } catch (error) {  
    console.error('Error loading files:', error);  
    document.getElementById('files-list').innerHTML =   
      `<p style="color: red;">Error loading files: ${error.message}</p>`;  
  }  
}  
  
// Upload file to Google Drive  
async function uploadToDrive() {  
  const fileInput = document.getElementById('file-input');  
  const status = document.getElementById('status');  
  
  if (!fileInput.files.length) {  
    status.innerHTML = '<span style="color:red;">Please select a file first.</span>';  
    return;  
  }  
  
  if (!accessToken) {  
    status.innerHTML = '<span style="color:red;">Please sign in first.</span>';  
    
    // Try to get token again
    if (tokenClient) {
      tokenClient.requestAccessToken();
    }
    return;  
  }  
  
  const file = fileInput.files[0];  
  status.innerHTML = `<span style="color:blue;">Uploading "${file.name}"... (Size: ${formatBytes(file.size)})</span>`;  
  
  console.log('Starting upload:', {
    fileName: file.name,
    fileSize: file.size,
    accessToken: accessToken.substring(0, 20) + '...'
  });
  
  try {  
    // Create metadata  
    const metadata = {  
      name: file.name,  
      parents: [FOLDER_ID],
      mimeType: file.type || 'application/octet-stream'
    };  
    
    // Create FormData for upload  
    const form = new FormData();  
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));  
    form.append('file', file);  
    
    // Upload to Google Drive  
    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,size', {  
      method: 'POST',  
      headers: {
        'Authorization': `Bearer ${accessToken}`
      },  
      body: form  
    });  
    
    console.log('Response status:', response.status, response.statusText);
    
    if (!response.ok) {  
      const errorText = await response.text();
      console.error('Upload failed:', errorText);
      
      // Check if token expired
      if (response.status === 401) {
        // Token likely expired, request a new one
        accessToken = null;
        status.innerHTML = `<span style="color:orange;">Session expired. Please sign in again.</span>`;
        
        // Show sign-in button again
        document.getElementById('upload-section').style.display = 'none';  
        document.getElementById('signin-button').style.display = 'block';
        return;
      }
      
      throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
    }  
    
    const result = await response.json();  
    console.log('Upload successful:', result);
    
    status.innerHTML = `  
      <span style="color:green;">  
        ‚úÖ Upload successful!<br>  
        <small>  
          File: ${result.name}<br>  
          <a href="https://drive.google.com/file/d/${result.id}/view" target="_blank">View in Drive</a> |  
          <a href="https://drive.google.com/uc?export=download&id=${result.id}" target="_blank">Download</a>  
        </small>  
      </span>  
    `;  
    
    // Clear file input and reload list  
    fileInput.value = '';  
    loadPublicFiles();  
  
  } catch (error) {  
    console.error('Upload error:', error);  
    status.innerHTML = `<span style="color:red;">Upload failed: ${error.message}</span>`;  
  }  
}  
  
// Helper function to format file sizes  
function formatBytes(bytes, decimals = 2) {  
  if (bytes === 0) return '0 Bytes';  
  const k = 1024;  
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];  
  const i = Math.floor(Math.log(bytes) / Math.log(k));  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];  
}  
  
// Sign out function  
function signOut() {  
  console.log('Signing out...');
  
  if (accessToken) {
    // Revoke the token
    google.accounts.oauth2.revoke(accessToken, () => {
      console.log('Token revoked');
    });
  }
  
  // Clear tokens and state
  accessToken = null;
  
  // Reset UI
  document.getElementById('upload-section').style.display = 'none';  
  document.getElementById('signin-button').style.display = 'block';  
  document.getElementById('status').innerHTML = '';
  
  // Clear Google Sign-In
  google.accounts.id.disableAutoSelect();
  
  console.log('Signed out successfully');
  
  // Reload files list
  loadPublicFiles();
}  
  
// Initialize when page loads  
window.onload = initGoogleAuth;
</script>  
  
<div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">  
  <button onclick="signOut()" style="background: #f44336; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">  
    Sign Out  
  </button>
  
  <button onclick="loadPublicFiles()" style="background: #2196F3; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">  
    Refresh Files  
  </button>
  
  <p style="margin-top: 10px; font-size: 12px; color: #666;">
    Note: After clicking "Sign in with Google", you'll be prompted to grant Drive access.
  </p>
</div>  
  
</body>  
</html>